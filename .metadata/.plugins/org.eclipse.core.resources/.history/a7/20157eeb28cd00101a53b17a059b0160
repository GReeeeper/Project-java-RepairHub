package presentation;

import metier.models.*;
import metier.services.BusinessService;

import javax.swing.*;
import javax.swing.border.TitledBorder;
import java.awt.*;
import java.util.List;

public class OwnerPanel extends JPanel {
    private final User owner;
    private final BusinessService service;

    private final DefaultListModel<String> repairerListModel = new DefaultListModel<>();
    private final JList<String> repairerList = new JList<>(repairerListModel);

    public OwnerPanel(User owner, BusinessService service) {
        super(new BorderLayout(8, 8));
        this.owner = owner;
        this.service = service;

        // Top: owner info
        JPanel top = new JPanel(new GridLayout(0, 1));
        top.setBorder(new TitledBorder("Owner Info"));
        top.add(new JLabel("Username: " + owner.getUsername()));
        top.add(new JLabel("Email: " + (owner.getEmail() == null ? "-" : owner.getEmail())));
        top.add(new JLabel("Phone: " + (owner.getPhone() == null ? "-" : owner.getPhone())));
        add(top, BorderLayout.NORTH);

        // Center: Shop & repairers
        JPanel center = new JPanel(new BorderLayout(6,6));
        center.setBorder(new TitledBorder("Shop & Repairers"));

        Shop shop = owner.getShop();
        String shopName = shop == null ? "No shop" : shop.getName();
        center.add(new JLabel("Shop: " + shopName), BorderLayout.NORTH);

        JScrollPane scroll = new JScrollPane(repairerList);
        center.add(scroll, BorderLayout.CENTER);

        // Right: controls
        JPanel controls = new JPanel(new GridLayout(0,1,6,6));
        JButton addRepairerBtn = new JButton("Add Repairer");
        controls.add(addRepairerBtn);

        // If owner is also a repairer (BOTH), show a label
        if (owner.getRole() == User.Role.BOTH) {
            controls.add(new JLabel("You are also a repairer"));
        }

        center.add(controls, BorderLayout.EAST);
        add(center, BorderLayout.CENTER);

        // Fill list
        refreshRepairers();

        // Add repairer action
        addRepairerBtn.addActionListener(e -> {
            if (shop == null) {
                JOptionPane.showMessageDialog(this, "Owner has no shop configured.");
                return;
            }
            JTextField u = new JTextField();
            JTextField email = new JTextField();
            JTextField phone = new JTextField();
            JPasswordField p = new JPasswordField();
            JPanel panel = new JPanel(new GridLayout(0,1,4,4));
            panel.add(new JLabel("Username:")); panel.add(u);
            panel.add(new JLabel("Email:")); panel.add(email);
            panel.add(new JLabel("Phone:")); panel.add(phone);
            panel.add(new JLabel("Password:")); panel.add(p);

            int res = JOptionPane.showConfirmDialog(this, panel, "Add Repairer", JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);
            if (res == JOptionPane.OK_OPTION) {
                try {
                    service.addRepairer(u.getText(), new String(p.getPassword()), email.getText(), phone.getText(), shop);
                    JOptionPane.showMessageDialog(this, "Repairer added.");
                    refreshRepairers();
                } catch (Exception ex) {
                    JOptionPane.showMessageDialog(this, "Error: " + ex.getMessage());
                }
            }
        });
    }

    private void refreshRepairers() {
        repairerListModel.clear();
        Shop shop = owner.getShop();
        if (shop == null) return;
        List<User> repairers = shop.getRepairers();
        if (repairers != null) {
            for (User r : repairers) {
                repairerListModel.addElement(r.getUsername() + " (" + (r.getEmail() == null ? "-" : r.getEmail()) + ")");
            }
        }
    }
}
