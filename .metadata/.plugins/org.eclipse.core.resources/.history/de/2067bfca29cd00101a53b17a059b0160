package metier.services;

import dao.LoanHistoryDAO;
import dao.ShopDAO;
import dao.UserDAO;
import lombok.NonNull;
import metier.models.*;

import java.util.List;

public class BusinessService {

    private final UserDAO userDAO = new UserDAO();
    private final ShopDAO shopDAO = new ShopDAO();
    private final RepairService repairService = new RepairService();
    private final LoanHistoryDAO loanHistoryDAO = new LoanHistoryDAO();

    // ======================= AUTHENTICATION =======================
    public User authenticate(String username, String password) throws Exception {
        return userDAO.authenticate(username, password);
    }

    // ======================= OWNER SIGNUP =======================
    public void signUpOwner(
            @NonNull String username,
            @NonNull String email,
            @NonNull String phone,
            @NonNull String password,
            @NonNull String confirmPassword,
            boolean isAlsoRepairer
    ) throws Exception {

        if (userDAO.getUserByUsername(username) != null)
            throw new Exception("⚠ Username already exists.");

        if (!password.equals(confirmPassword))
            throw new Exception("⚠ Password confirmation does not match.");

        if (!email.contains("@"))
            throw new Exception("⚠ Invalid email address.");

        if (phone.length() < 8)
            throw new Exception("⚠ Invalid phone number.");

        User.Role role = isAlsoRepairer ? User.Role.BOTH : User.Role.OWNER;
        User owner = new User(username, password, email, phone, role);
        userDAO.addUser(owner);
    }

    public boolean hasOwner() {
        return userDAO.getAllUsers().stream()
                .anyMatch(u -> u.getRole() == User.Role.OWNER || u.getRole() == User.Role.BOTH);
    }

    public void createDefaultOwner() throws Exception {
        if (!hasOwner()) {
            signUpOwner("owner1", "owner1@example.com", "0612345678", "TechRepair", "password123", "password123", true);
        }
    }
    public void createShopForOwner(User owner, String shopName) throws Exception {
        if (shopDAO.getShopByOwner(owner) != null)
            throw new Exception("⚠ This owner already has a shop.");

        Shop shop = new Shop(shopName, owner);
        shopDAO.addShop(shop);
    }

    // ======================= ADD REPAIRER =======================
    /**
     * Add a repairer and attach to a shop.
     */
    public void addRepairer(@NonNull String username,
                            @NonNull String password,
                            String email,
                            String phone,
                            @NonNull Shop shop) throws Exception {

        if (username.isBlank() || password.isBlank()) throw new Exception("Username and password required.");
        if (shop == null) throw new Exception("Shop required to add repairer.");

        if (userDAO.getUserByUsername(username) != null)
            throw new Exception("Username already exists!");

        User repairer = new User(username, password, email, phone, User.Role.REPAIRER);
        userDAO.addUser(repairer);

        // link
        shop.addRepairer(repairer);
        repairer.setShop(shop);
    }

    // convenience older name (if other code used it)
    public void addRepairerToShop(@NonNull String username,
                                  @NonNull String email,
                                  @NonNull String phone,
                                  @NonNull String password,
                                  @NonNull Shop shop) throws Exception {
        addRepairer(username, password, email, phone, shop);
    }

    // ======================= SHOP =======================
    public Shop getShopByOwner(User owner) {
        return shopDAO.getShopByOwner(owner);
    }

    public Shop getShopByRepairer(User repairer) {
        return shopDAO.getShopByRepairer(repairer);
    }

    public void updateShopCash(Shop shop, double amount) {
        shopDAO.updateCash(amount, shop);
    }

    public List<Shop> getAllShops() {
        return shopDAO.getAllShops();
    }

    // ======================= REPAIR MANAGEMENT =======================
    public void addRepair(Repair repair) {
        repairService.addRepair(repair);
    }

    public Repair getRepairByCode(String code) {
        return repairService.getRepairByCode(code);
    }

    public List<Repair> getAllRepairs() {
        return repairService.getAllRepairs();
    }

    public List<Repair> getPendingRepairs() {
        return repairService.getRepairsByStatus(Repair.Status.PENDING);
    }

    public void validateRepair(Repair repair) {
        repairService.validateRepair(repair);
    }

    public void completeRepairPayment(Repair repair) {
        repairService.completeRepairPayment(repair);

        if (repair != null && repair.getAssignedRepairer() != null) {
            Shop shop = getShopByRepairer(repair.getAssignedRepairer());
            if (shop != null) {
                shopDAO.updateCash(repair.getTotalCost(), shop);
            }
        }
    }

    public List<Repair> getRepairsByRepairer(User repairer) {
        return repairService.getRepairsByRepairer(repairer);
    }

    // ======================= LOAN HISTORY =======================
    public void addLoanHistory(LoanHistory history) {
        loanHistoryDAO.addLoanHistory(history);
    }

    public List<LoanHistory> getAllLoanHistories() {
        return loanHistoryDAO.getAllLoanHistories();
    }
}
