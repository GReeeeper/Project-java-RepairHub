package presentation;

import javax.swing.*;
import java.awt.*;
import metier.models.*;
import metier.services.BusinessService;

public class MainFrame extends JFrame {

    private final BusinessService service = new BusinessService();

    public MainFrame() {
        setTitle("Repair Hub");
        setSize(900, 650);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        try {
            service.createDefaultOwner();
        } catch (Exception e) {
            e.printStackTrace();
        }

        showLoginPanel();
    }

    private void showLoginPanel() {
        getContentPane().removeAll();

        JPanel panel = new JPanel(new GridBagLayout());
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(6,6,6,6);

        JTextField usernameField = new JTextField(16);
        JPasswordField passwordField = new JPasswordField(16);
        JTextField clientCodeField = new JTextField(12);
        JButton loginBtn = new JButton("Login");
        JButton clientCheckBtn = new JButton("Check Repair");

        gbc.gridx=0; gbc.gridy=0; panel.add(new JLabel("Username:"), gbc);
        gbc.gridx=1; gbc.gridy=0; panel.add(usernameField, gbc);

        gbc.gridx=0; gbc.gridy=1; panel.add(new JLabel("Password:"), gbc);
        gbc.gridx=1; gbc.gridy=1; panel.add(passwordField, gbc);

        gbc.gridx=0; gbc.gridy=2; panel.add(loginBtn, gbc);

        // First-time owner sign up button (visible only if no owner exists)
        if (!service.hasOwner()) {
            JButton signUpBtn = new JButton("Sign Up (First Owner)");
            gbc.gridx=1; gbc.gridy=2; panel.add(signUpBtn, gbc);
            signUpBtn.addActionListener(e -> openOwnerSignupDialog());
        }

        // Client repair check section
        gbc.gridx=0; gbc.gridy=3; panel.add(new JLabel("Client code:"), gbc);
        gbc.gridx=1; gbc.gridy=3; panel.add(clientCodeField, gbc);
        gbc.gridx=2; gbc.gridy=3; panel.add(clientCheckBtn, gbc);

        clientCheckBtn.addActionListener(e -> {
            String code = clientCodeField.getText();
            if (code == null || code.isBlank()) {
                JOptionPane.showMessageDialog(this, "Enter client code.");
                return;
            }
            Repair r = service.getRepairByCode(code);
            if (r != null) {
                JOptionPane.showMessageDialog(this,
                        "Repair Code: " + r.getCode() +
                        "\nStatus: " + r.getStatus() +
                        "\nPrice: " + r.getTotalCost());
            } else {
                JOptionPane.showMessageDialog(this, "Repair not found.");
            }
        });

        loginBtn.addActionListener(e -> {
            try {
                User user = service.authenticate(usernameField.getText(), new String(passwordField.getPassword()));
                switch (user.getRole()) {
                    case OWNER, BOTH -> showOwnerPanel(user);
                    case REPAIRER -> showRepairerPanel(user);
                }
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Login failed: " + ex.getMessage());
            }
        });

        getContentPane().add(panel);
        revalidate();
        repaint();
    }

    private void openOwnerSignupDialog() {
        JTextField username = new JTextField();
        JTextField email = new JTextField();
        JTextField phone = new JTextField();
        JTextField shopName = new JTextField();
        JPasswordField password = new JPasswordField();
        JPasswordField confirmPassword = new JPasswordField();
        JCheckBox bothCheck = new JCheckBox("I am also a repairer");

        JPanel panel = new JPanel(new GridLayout(0, 1, 4, 4));
        panel.add(new JLabel("Username:")); panel.add(username);
        panel.add(new JLabel("Email:")); panel.add(email);
        panel.add(new JLabel("Phone:")); panel.add(phone);
        panel.add(new JLabel("Shop name:")); panel.add(shopName);
        panel.add(new JLabel("Password:")); panel.add(password);
        panel.add(new JLabel("Confirm Password:")); panel.add(confirmPassword);
        panel.add(bothCheck);

        int result = JOptionPane.showConfirmDialog(this, panel, "Owner Sign Up", JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);
        if (result == JOptionPane.OK_OPTION) {
            try {
                service.signUpOwner(
                        username.getText(),
                        email.getText(),
                        phone.getText(),
                        shopName.getText(),
                        new String(password.getPassword()),
                        new String(confirmPassword.getPassword()),
                        bothCheck.isSelected()
                );
                JOptionPane.showMessageDialog(this, "Owner account and shop created!");
                showLoginPanel();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Error: " + ex.getMessage());
            }
        }
    }

    private void showOwnerPanel(User owner) {
        getContentPane().removeAll();
        OwnerPanel ownerPanel = new OwnerPanel(owner, service);
        JButton logout = new JButton("Logout");
        logout.addActionListener(e -> showLoginPanel());
        ownerPanel.add(logout, BorderLayout.SOUTH);
        getContentPane().add(ownerPanel, BorderLayout.CENTER);
        revalidate();
        repaint();
    }

    private void showRepairerPanel(User repairer) {
        getContentPane().removeAll();
        RepairerPanel repairerPanel = new RepairerPanel(repairer, service);
        JButton logout = new JButton("Logout");
        logout.addActionListener(e -> showLoginPanel());
        repairerPanel.add(logout, BorderLayout.SOUTH);
        getContentPane().add(repairerPanel, BorderLayout.CENTER);
        revalidate();
        repaint();
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> {
            MainFrame frame = new MainFrame();
            frame.setVisible(true);
        });
    }
}
